name: Dagu Image Build

on:
  push:
    branches:
      - "main"
    paths:
      - "infra/dagu/**"
      - "apps/todops-cli/**"

defaults:
  run:
    shell: bash -leo pipefail {0}

env:
  IMG_NAME: curiosinauts/scottseotech-dagu
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

run-name: "Dagu Image Build - ${{ github.run_id }}"

jobs:
  start:
    uses: ./.github/workflows/slack-notification.yaml
    with:
      status: 'starting'
      workflow_name: 'Dagu Image Build'
      message: 'Starting build and deployment'
      branch: ${{ github.ref_name }}
      actor: ${{ github.actor }}
      channel: '#builds'
    secrets: inherit

  build:
    needs: start
    uses: ./.github/workflows/reusable-docker-build.yaml
    with:
      image_name: curiosinauts/scottseotech-dagu
      context: .
      file: infra/dagu/Dockerfile
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  call:
    needs: build
    uses: ./.github/workflows/argocd-update.yaml
    with:
      namespace: todo
      app_path: deploy/argocd/manifests/applications
      app: dagu
      version: ${{ needs.build.outputs.image_version }}
    secrets: inherit

  success:
    needs: [build, call]
    if: success()
    uses: ./.github/workflows/slack-notification.yaml
    with:
      status: 'success'
      workflow_name: 'Dagu Image Build'
      message: 'Build and deployment completed'
      branch: ${{ github.ref_name }}
      actor: ${{ github.actor }}
      channel: '#builds'
    secrets: inherit

  failure:
    needs: [build, call]
    if: failure()
    uses: ./.github/workflows/slack-notification.yaml
    with:
      status: 'failure'
      workflow_name: 'Dagu Image Build'
      message: 'Build pipeline failed - check logs for details'
      branch: ${{ github.ref_name }}
      actor: ${{ github.actor }}
      channel: '#builds'
    secrets: inherit