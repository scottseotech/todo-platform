name: Services Deployment

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: git tag
      services:
        type: string
        required: true
        description: service names matrix 
        # e.g. { "service": [ "todo-api", "todo-mcp", "todo-bot" ] }

defaults:
  run:
    shell: bash -leo pipefail {0}

run-name: "Services Deployment - ${{ inputs.version }}"

jobs:

  call:
    strategy:
      matrix: ${{ fromJson(inputs.services) }}
    uses: ./.github/workflows/image-build.yaml
    with:
      service: ${{ matrix.service }}
      version: ${{ inputs.version }}
    secrets: inherit

  success:
    needs: [call]
    if: success()
    uses: ./.github/workflows/slack-notification-deployment.yaml
    with:
      status: 'success'
      workflow_name: 'Services Deployment'
      message: '${{ toJson(fromJson(inputs.services).service) }} completed'
      version: ${{ inputs.version }}
      actor: ${{ github.actor }}
      channel: '#deployments'
    secrets: inherit

  failure:
    needs: [call]
    if: failure()
    uses: ./.github/workflows/slack-notification-deployment.yaml
    with:
      status: 'failure'
      workflow_name: 'Services Deployment'
      message: '${{ toJson(fromJson(inputs.services).service) }} failed'
      version: ${{ inputs.version }}
      actor: ${{ github.actor }}
      channel: '#deployments'
    secrets: inherit