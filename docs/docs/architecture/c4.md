# C4 Architecture Diagrams

!!! tip "Best Viewed in Light Mode"
    For optimal visibility of diagram labels and relationship text, switch to light mode using the theme toggle in the header (‚òÄÔ∏è/üåô icon).

## About C4 Model

The **C4 model** provides a hierarchical approach to documenting software architecture through four levels of abstraction: Context, Containers, Components, and Code. These diagrams help visualize the system at different zoom levels‚Äîfrom high-level system landscape to detailed component interactions.

This platform uses C4 diagrams to demonstrate:

- How external systems interact with the platform (Context)
- What containers (deployable units) make up the system (Containers)
- How components within services are organized (Components)

---

## Level 1: System Context

The highest level view showing how the Reference Platform fits into the broader ecosystem.

```mermaid
C4Context
    title System Context - Reference Platform

    Person(user, "Platform User", "Developer or operator managing applications")
    Person(enduser, "End User", "User interacting via Slack")

    System(platform, "Reference Platform", "Kubernetes-based platform demonstrating GitOps, observability, and ChatOps patterns")

    System_Ext(github, "GitHub", "Source control and CI/CD automation")
    System_Ext(dockerhub, "Docker Hub", "Container image registry")
    System_Ext(slack, "Slack", "Chat interface for operations")
    System_Ext(openai, "OpenAI", "LLM provider for AI features")

    Rel(user, platform, "Deploys code, monitors", "Git, kubectl, Grafana")
    Rel(enduser, slack, "Manages todos", "Slack messages")
    Rel(slack, platform, "Sends commands", "MCP protocol")
    Rel(platform, openai, "Processes natural language", "OpenAI API")
    Rel(platform, github, "Triggers workflows, fetches code", "GitHub API")
    Rel(platform, dockerhub, "Pulls images", "Docker Registry API")
    Rel(github, dockerhub, "Pushes built images", "Docker Registry API")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

**Key Interactions:**

- Users deploy via Git ‚Üí GitHub Actions ‚Üí ArgoCD ‚Üí Kubernetes
- End users interact via Slack ‚Üí MCP Server ‚Üí REST API
- Platform pulls images from Docker Hub for deployments
- LLM processes natural language commands through OpenAI

---

## Level 2: Container Diagram

Shows the high-level technical building blocks (containers) that make up the platform.

```mermaid
C4Container
    title Container Diagram - Reference Platform

    Person(user, "End User", "Manages todos via Slack")
    Person(operator, "Operator", "Manages platform")

    System_Boundary(platform, "Reference Platform") {
        Container(slackbot, "Slack Bot", "Python, Bolt SDK", "Handles Slack events and commands")
        Container(mcp, "MCP Server", "Go", "Model Context Protocol server for AI tool calling")
        Container(api, "Todo API", "Go, Gin", "REST API for todo operations")
        ContainerDb(db, "Database", "PostgreSQL, CNPG", "Stores todo data with HA")

        Container(argocd, "ArgoCD", "Kubernetes Operator", "GitOps continuous deployment")
        Container(arc, "ARC Runners", "Kubernetes, GitHub Actions", "Self-hosted CI/CD runners")

        Container(tempo, "Tempo", "Grafana Tempo", "Distributed tracing storage")
        Container(loki, "Loki", "Grafana Loki", "Log aggregation and storage")
        Container(prometheus, "Prometheus", "Prometheus", "Metrics collection")
        Container(grafana, "Grafana", "Grafana", "Unified observability dashboard")

        Container(minio, "MinIO", "S3-compatible storage", "Backup storage for DB and logs")
    }

    System_Ext(github, "GitHub", "Source control and workflows")
    System_Ext(dockerhub, "Docker Hub", "Container registry")
    System_Ext(openai, "OpenAI API", "LLM provider")

    Rel(user, slackbot, "Sends commands", "Slack API")
    Rel(slackbot, openai, "Processes NL", "HTTPS")
    Rel(slackbot, mcp, "Invokes tools", "HTTP/MCP")
    Rel(mcp, api, "CRUD operations", "HTTP/REST")
    Rel(api, db, "Reads/writes", "PostgreSQL")

    Rel(operator, grafana, "Views metrics/traces", "HTTPS")
    Rel(api, tempo, "Sends traces", "OTLP/gRPC")
    Rel(api, prometheus, "Exposes metrics", "/metrics")
    Rel(mcp, tempo, "Sends traces", "OTLP/gRPC")
    Rel(mcp, prometheus, "Exposes metrics", "/metrics")

    Rel(grafana, tempo, "Queries traces", "HTTP")
    Rel(grafana, loki, "Queries logs", "HTTP")
    Rel(grafana, prometheus, "Queries metrics", "PromQL")

    Rel(db, minio, "Continuous backup", "S3 API")
    Rel(loki, minio, "Stores logs", "S3 API")

    Rel(github, arc, "Dispatches jobs", "GitHub API")
    Rel(arc, dockerhub, "Pushes images", "Docker API")
    Rel(argocd, github, "Syncs manifests", "Git")

    UpdateLayoutConfig($c4ShapeInRow="4", $c4BoundaryInRow="2")
```

**Key Containers:**

- **Application Services**: Slack Bot, MCP Server, Todo API
- **Data Storage**: PostgreSQL (CNPG), MinIO
- **Platform Services**: ArgoCD, ARC Runners
- **Observability**: Tempo, Loki, Prometheus, Grafana

---

## Level 3: Component Diagram - Todo API

Detailed view of components within the Todo API service.

```mermaid
C4Component
    title Component Diagram - Todo API Service

    Person(client, "API Client", "MCP Server or direct HTTP client")

    Container_Boundary(api, "Todo API") {
        Component(router, "HTTP Router", "Gin", "Routes HTTP requests to handlers")
        Component(handler, "Todo Handlers", "Go", "HTTP request handlers for CRUD operations")
        Component(service, "Todo Service", "Go", "Business logic for todo operations")
        Component(repository, "Todo Repository", "Go, GORM", "Data access layer")
        Component(otel, "OpenTelemetry", "OTEL SDK", "Trace instrumentation")
        Component(metrics, "Metrics Exporter", "Prometheus", "Exposes /metrics endpoint")
    }

    ContainerDb(db, "PostgreSQL", "CloudNativePG", "Todo data storage")
    Container(tempo, "Tempo", "Trace collector", "Receives traces")
    Container(prometheus, "Prometheus", "Metrics scraper", "Scrapes /metrics")

    Rel(client, router, "HTTP requests", "REST/JSON")
    Rel(router, handler, "Dispatch", "Function call")
    Rel(handler, service, "Business operations", "Function call")
    Rel(service, repository, "Data operations", "Function call")
    Rel(repository, db, "SQL queries", "PostgreSQL protocol")

    Rel(handler, otel, "Create spans", "OTEL SDK")
    Rel(service, otel, "Create spans", "OTEL SDK")
    Rel(otel, tempo, "Export traces", "OTLP/gRPC :4317")

    Rel(metrics, prometheus, "Scraped by", "HTTP :8080/metrics")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

**Component Responsibilities:**

- **Router**: Request routing with middleware (CORS, logging, recovery)
- **Handlers**: HTTP-specific logic, request validation, response serialization
- **Service**: Business rules, transaction management, error handling
- **Repository**: Database queries, ORM mapping, connection pooling
- **OpenTelemetry**: Span creation, context propagation, trace export
- **Metrics**: Prometheus metrics (request counts, latencies, errors)

---

## Level 3: Component Diagram - MCP Server

Detailed view of components within the MCP Server.

```mermaid
C4Component
    title Component Diagram - MCP Server

    Person(ai, "AI Assistant", "OpenAI or compatible LLM")

    Container_Boundary(mcp, "MCP Server") {
        Component(server, "MCP Server", "Go, MCP SDK", "Handles MCP protocol requests")
        Component(tools, "Tool Registry", "Go", "Registers and dispatches tool calls")
        Component(todotool, "Todo Tools", "Go", "MCP tools for todo operations")
        Component(client, "API Client", "Go, HTTP client", "Communicates with Todo API")
        Component(otel, "OpenTelemetry", "OTEL SDK", "Trace instrumentation")
    }

    Container(api, "Todo API", "REST API", "Backend service")
    Container(tempo, "Tempo", "Trace collector", "Receives traces")

    Rel(ai, server, "Tool invocations", "MCP/JSON-RPC")
    Rel(server, tools, "Dispatch tool", "Function call")
    Rel(tools, todotool, "Execute", "Function call")
    Rel(todotool, client, "HTTP requests", "REST/JSON")
    Rel(client, api, "API calls", "HTTP")

    Rel(server, otel, "Create spans", "OTEL SDK")
    Rel(todotool, otel, "Create spans", "OTEL SDK")
    Rel(otel, tempo, "Export traces", "OTLP/gRPC :4317")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

**Component Responsibilities:**

- **MCP Server**: Protocol handling, JSON-RPC transport, tool discovery
- **Tool Registry**: Tool registration, validation, dispatch
- **Todo Tools**: MCP tool implementations (add, list, complete, delete todos)
- **API Client**: HTTP client with retry logic, timeout handling
- **OpenTelemetry**: Trace context extraction/injection, span lifecycle

---

## Deployment Diagram

Shows how containers are deployed to infrastructure.

```mermaid
C4Deployment
    title Deployment Diagram - Kubernetes Cluster

    Deployment_Node(k8s, "Kubernetes Cluster", "K3s") {
        Deployment_Node(default_ns, "Namespace: default") {
            Container(slackbot, "Slack Bot", "Deployment")
            Container(mcp, "MCP Server", "Deployment")
            Container(api, "Todo API", "Deployment")
        }

        Deployment_Node(cnpg_ns, "Namespace: cnpg") {
            ContainerDb(db, "PostgreSQL Cluster", "StatefulSet, 2 replicas")
        }

        Deployment_Node(argocd_ns, "Namespace: argocd") {
            Container(argocd, "ArgoCD", "Deployment")
        }

        Deployment_Node(arc_ns, "Namespace: arc-runners") {
            Container(arc, "GitHub Runners", "ScaleSet, 2-5 replicas")
        }

        Deployment_Node(monitoring_ns, "Namespace: monitoring") {
            Container(grafana, "Grafana", "Deployment")
            Container(prometheus, "Prometheus", "StatefulSet")
            Container(tempo, "Tempo", "Deployment")
            Container(loki, "Loki", "StatefulSet")
        }

        Deployment_Node(minio_ns, "Namespace: minio") {
            Container(minio, "MinIO", "StatefulSet, 4 replicas")
        }
    }

    Deployment_Node(external, "External Services") {
        System_Ext(github, "GitHub")
        System_Ext(dockerhub, "Docker Hub")
        System_Ext(slack, "Slack")
    }

    Rel(argocd, github, "Git sync")
    Rel(arc, github, "Job execution")
    Rel(arc, dockerhub, "Image push")
    Rel(slackbot, slack, "Events")

    UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")
```

**Deployment Characteristics:**

- **High Availability**: Database with 2 replicas, auto-failover
- **Auto-Scaling**: ARC runners scale 2-5 based on job queue
- **Resource Isolation**: Separate namespaces for different concerns
- **StatefulSets**: Used for databases and storage requiring persistent volumes
- **Deployments**: Used for stateless application services

## Benefits of C4 Diagrams

**For this platform:**

- **Context**: Shows how external systems integrate (GitHub, Slack, OpenAI)
- **Containers**: Reveals the microservices architecture and infrastructure services
- **Components**: Demonstrates internal service organization and patterns
- **Deployment**: Illustrates Kubernetes topology and scaling characteristics

**For recruiters/engineers:**

- Hierarchical views from business context to technical detail
- Clear separation of concerns across namespaces
- Observable patterns: tracing, metrics, logging flows
- Production patterns: HA databases, auto-scaling, GitOps

## Related Documentation

- [Architecture Overview](overview.md)
- [Architecture Decision Records](adr.md)
- [Deployment Documentation](../deployment/kubernetes.md)
- [Observability Stack](../observability/observability.md)
